from models import User
from api import Blockchain, Crypto
import telebot
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton
import logging
import pytz
from datetime import datetime

ADMINISTRATORS = ['ADMINISTRATOR_ID', 'ADMINISTRATOR_ID']
API_KEY = 'BLOCKCYPHER_API_KEY'

temp = {}

logging.basicConfig(filename='infos.log',
                    level=logging.INFO,
                    format='%(asctime)s:%(levelname)s: %(message)s')

bot = telebot.TeleBot(token='TELEGRAM_BOT_TOKEN', parse_mode=None)
logging.info("Le bot Telegram est connect√©.")

@bot.message_handler(commands=['start'])
def start_command(message):
    user = User(user_id=message.from_user.id)
    markup = InlineKeyboardMarkup()
    
    markup.add(InlineKeyboardButton("üÜï Suivre une nouvelle transaction", callback_data="new_transaction"))
    markup.add(InlineKeyboardButton(f"üóÇÔ∏è Mes transactions suivies ({len(user.get_all_transactions())})", callback_data="my_transactions:1"))
    markup.add(InlineKeyboardButton("‚öôÔ∏è Param√®tres", callback_data="settings"))
        
    bot_message = bot.send_message(message.chat.id, '*ü§ñ Accueil*\nBonjour, je suis *CryptoTracker* votre assistant pour vous aider √† suivre vos transactions en cryptomonnaies.' , reply_markup=markup, parse_mode='Markdown')
    
    temp[message.from_user.id] = {'message': bot_message.id, 'new_transaction': {}}


@bot.callback_query_handler(func=lambda call: True)
def callback_query(call):
    
    user = User(user_id=call.from_user.id)
    markup = InlineKeyboardMarkup()

    
    match call.data:
        case 'new_transaction':
            bot.clear_step_handler_by_chat_id(call.from_user.id)
            bot.answer_callback_query(call.id)
            
            markup.add(InlineKeyboardButton("‚ùå Annuler", callback_data="back_to_menu"))
            markup.add(InlineKeyboardButton("BTC", callback_data="new_transaction_btc"),
                       InlineKeyboardButton("ETH", callback_data="new_transaction_eth"),
                       InlineKeyboardButton("LTC", callback_data="new_transaction_ltc")
                       )
            
            message = bot.edit_message_text(chat_id=call.from_user.id, 
                                            message_id=temp[call.from_user.id]['message'],
                                            text="üßæ De quelle cryptomonnaie s'agit-il ?", 
                                            reply_markup=markup,
                                            parse_mode='Markdown')
            
        case 'new_transaction_btc':
            bot.clear_step_handler_by_chat_id(call.from_user.id)
            bot.answer_callback_query(call.id)
            
            temp[call.from_user.id]['new_transaction'] = {'txid': '', 'name': '', 'coin_symbol': Crypto.BITCOIN, 'finished': None}
            
            markup.add(InlineKeyboardButton("‚ùå Annuler", callback_data="back_to_menu"))
            
            message = bot.edit_message_text(chat_id=call.from_user.id, 
                                            message_id=temp[call.from_user.id]['message'],
                                            text="üßæ *Entrez votre TXID*\n\nBlockchain : BTC", 
                                            reply_markup=markup,
                                            parse_mode='Markdown')
            
            bot.register_next_step_handler(message, new_transaction_step_txid)
            
        
        case 'new_transaction_eth':
            bot.clear_step_handler_by_chat_id(call.from_user.id)
            bot.answer_callback_query(call.id)
            
            temp[call.from_user.id]['new_transaction'] = {'txid': '', 'name': '', 'coin_symbol': Crypto.ETHEREUM, 'finished': None}

            markup.add(InlineKeyboardButton("‚ùå Annuler", callback_data="back_to_menu"))
            
            message = bot.edit_message_text(chat_id=call.from_user.id, 
                                            message_id=temp[call.from_user.id]['message'],
                                            text="üßæ *Entrez votre TXID*\n\nBlockchain : ETH", 
                                            reply_markup=markup,
                                            parse_mode='Markdown')
            
            bot.register_next_step_handler(message, new_transaction_step_txid)
        
        case 'new_transaction_ltc':
            bot.clear_step_handler_by_chat_id(call.from_user.id)
            bot.answer_callback_query(call.id)
            
            temp[call.from_user.id]['new_transaction'] = {'txid': '', 'name': '', 'coin_symbol': Crypto.LITECOIN, 'finished': None}
            
            markup.add(InlineKeyboardButton("‚ùå Annuler", callback_data="back_to_menu"))
            
            message = bot.edit_message_text(chat_id=call.from_user.id, 
                                            message_id=temp[call.from_user.id]['message'],
                                            text="üßæ *Entrez votre TXID*\n\nBlockchain : LTC", 
                                            reply_markup=markup,
                                            parse_mode='Markdown')
            
            bot.register_next_step_handler(message, new_transaction_step_txid)
        
        case 'settings':
            bot.clear_step_handler_by_chat_id(call.from_user.id)
            bot.answer_callback_query(call.id)
            
            markup.add(InlineKeyboardButton("‚Ü™Ô∏è Menu principal", callback_data="back_to_menu"))
            markup.add(InlineKeyboardButton("üì™ Contacter le cr√©ateur", callback_data="contact"))
            markup.add(InlineKeyboardButton("‚ö†Ô∏è Supprimer mon compte", callback_data="delete_account"))
            
            data = '"' + str(call.from_user.id) + '": ' + str(user.get_all_informations())
            if len(data) > 2000:
                data = "Donn√©es trop longues pour √™tre affich√©."
            
            message = bot.edit_message_text(chat_id=call.from_user.id, 
                                            message_id=temp[call.from_user.id]['message'],
                                            text=f'‚öôÔ∏è *Param√®tres*\nAcc√©der √† vos informations et g√©rer votre compte.\n\n*Une copie de vos donn√©es que nous poss√©dons :*\n' + data, 
                                            reply_markup=markup,
                                            parse_mode='Markdown')
        case 'back_to_menu':
            bot.clear_step_handler_by_chat_id(call.from_user.id)
            bot.answer_callback_query(call.id)
            
            markup.add(InlineKeyboardButton("üÜï Nouvelle transaction", callback_data="new_transaction"))
            markup.add(InlineKeyboardButton(f"üóÇÔ∏è Mes transactions suivis ({len(user.get_all_transactions())})", callback_data="my_transactions:1"))
            markup.add(InlineKeyboardButton("‚öôÔ∏è Param√®tres", callback_data="settings"))
            
            message = bot.edit_message_text(chat_id=call.from_user.id, 
                                            message_id=temp[call.from_user.id]['message'],
                                            text='*ü§ñ Accueil*\nBonjour, je suis *CryptoTracker* votre assistant pour vous aider √† suivre vos transactions en cryptomonnaies.', 
                                            reply_markup=markup,
                                            parse_mode='Markdown')
        
        case 'contact':
            bot.clear_step_handler_by_chat_id(call.from_user.id)
            bot.answer_callback_query(call.id)
            
            markup.add(InlineKeyboardButton("‚Ü™Ô∏è Menu principal", callback_data="back_to_menu"))
            
            message = bot.edit_message_text(chat_id=call.from_user.id, 
                                            message_id=temp[call.from_user.id]['message'],
                                            text="üì≠ *√âcrivez votre message*\nIl sera envoy√© par Telegram au cr√©ateur du bot. Votre identifiant unique ainsi que votre nom d'utilisateur sera aussi transmis.", 
                                            reply_markup=markup,
                                            parse_mode='Markdown')
            
            bot.register_next_step_handler(message, contact_send_message)
            
        case 'delete_account':
            bot.clear_step_handler_by_chat_id(call.from_user.id)
            bot.answer_callback_query(call.id)
            
            markup.add(InlineKeyboardButton("‚Ü™Ô∏è Menu principal", callback_data="back_to_menu")) 
            markup.add(InlineKeyboardButton("‚ùå Supprimer mon compte", callback_data="delete_account_confirm"))
            
            message = bot.edit_message_text(chat_id=call.from_user.id, 
                                            message_id=temp[call.from_user.id]['message'],
                                            text="‚ö†Ô∏è *Supprimer vos donn√©es*\nVous √™tes sur le point de supprimer toutes vos informations enregistr√©s.", 
                                            reply_markup=markup,
                                            parse_mode='Markdown')
            
        case 'delete_account_confirm':
            bot.clear_step_handler_by_chat_id(call.from_user.id)
            bot.answer_callback_query(call.id)
            
            user.delete()
            
            message = bot.edit_message_text(chat_id=call.from_user.id, 
                                            message_id=temp[call.from_user.id]['message'],
                                            text="*üëã Au revoir !*\n\nToute les donn√©es que nous avions sur vous ont √©t√© supprim√© avec succ√®s. Si vous renvoyez un message, un nouveau compte sera cr√©√©.", 
                                            reply_markup=markup,
                                            parse_mode='Markdown')
            
        case 'nothing':
            bot.clear_step_handler_by_chat_id(call.from_user.id)
            bot.answer_callback_query(call.id)
            
    if call.data.startswith('my_transactions:'):
        bot.clear_step_handler_by_chat_id(call.from_user.id)
        bot.answer_callback_query(call.id)
        
        page = int(call.data[16:])
            
        nb_transactions = len(user.get_all_transactions())
        nb_page = 0
            
        while nb_transactions > 0:
            nb_page +=1
            nb_transactions -= 5
        if nb_page == 0:
            nb_page = 1
            
        markup.add(InlineKeyboardButton("‚Ü™Ô∏è Menu principal", callback_data="back_to_menu"))
        
        all_transactions = user.get_all_transactions()
        transactions = []
        for i in range(len(user.get_all_transactions())):  
            if (page*5)-5 <= i <= (page*5)-1:
                transactions.append(InlineKeyboardButton(f"ü™ô {all_transactions[i][1]['name']} ({all_transactions[i][1]['coin_symbol'].upper()})", callback_data=f"transaction:{all_transactions[i][0][:20]}"))
        
        for transaction in transactions:
            markup.add(transaction)
        
        buttons = []
        if nb_page == 1 and page == 1:
            markup.add(InlineKeyboardButton("‚ùå", callback_data="nothing"),
                   InlineKeyboardButton(f"Page {page}/{nb_page}", callback_data="nothing"),
                   InlineKeyboardButton("‚ùå", callback_data="nothing"))
        elif page == 1:
            markup.add(InlineKeyboardButton("‚ùå", callback_data="nothing"),
                   InlineKeyboardButton(f"Page {page}/{nb_page}", callback_data="nothing"),
                   InlineKeyboardButton("‚û°Ô∏è", callback_data="my_transactions:" + str(page + 1)))
        elif page >= nb_page:
            markup.add(InlineKeyboardButton("‚¨ÖÔ∏è", callback_data="my_transactions:" + str(page - 1)),
                   InlineKeyboardButton(f"Page {page}/{nb_page}", callback_data="nothing"),
                   InlineKeyboardButton("‚ùå", callback_data="nothing"))
        else:
            markup.add(InlineKeyboardButton("‚¨ÖÔ∏è", callback_data="my_transactions:" + str(page - 1)),
                   InlineKeyboardButton(f"Page {page}/{nb_page}", callback_data="nothing"),
                   InlineKeyboardButton("‚û°Ô∏è", callback_data="my_transactions:" + str(page + 1)))
    
    
            
        message = bot.edit_message_text(chat_id=call.from_user.id, 
                                        message_id=temp[call.from_user.id]['message'],
                                        text="*üìÇ Mes transactions enregistr√©es *\nAcc√©der et g√©rer mes transactions enregistr√©s.", 
                                        reply_markup=markup,
                                        parse_mode='Markdown')
        
    if call.data.startswith('transaction:'):
        bot.clear_step_handler_by_chat_id(call.from_user.id)
        bot.answer_callback_query(call.id)
        
        bc = Blockchain(api_key=API_KEY)
        
        transaction_txid = call.data[12:]
        transaction_data = user.get_transaction(txid=transaction_txid)
        
        markup.add(InlineKeyboardButton("‚Ü™Ô∏è Retour", callback_data="my_transactions:1"))  
        markup.add(InlineKeyboardButton("‚ùå Supprimer le suivi", callback_data=f"delete_transaction:{transaction_data[0][:20]}"))
        
        transaction_infos = bc.check_transaction(transaction_id=transaction_data[0],
                                                 coin_symbol=transaction_data[1]['coin_symbol'])
        
        
        if transaction_infos: 
            
            inputs, outputs = '', ''
        
            for input_addresse in transaction_infos['inputs']:
                inputs = inputs + f"{input_addresse['addresses']}\n"
            
            for output_addresse in transaction_infos['outputs']:
                outputs = outputs + f"{output_addresse['addresses']}\n" 
                
            inputs, outputs = inputs.replace("'", ""), outputs.replace("'", "")

            date = transaction_infos['received'].strftime("%d/%m/%Y %H:%M:%S")

            text = f"*üìÇ Transaction {transaction_data[1]['name']}*\n\n*üîó Blockchain*\n{transaction_data[1]['coin_symbol'].upper()}\n\n*ü™™ TXID*\n{transaction_data[0]}\n\n*üõ´ De*\n{ inputs }\n*üõ¨ Vers*\n{ outputs }\n*üíµ Prix*\n{ '{:f}'.format(bc.convert(transaction_data[1]['coin_symbol'], transaction_infos['total']))  } {transaction_data[1]['coin_symbol'].upper()}\n\n*{'‚úÖ' if transaction_infos['confirmations'] >= 6 else '‚ö†Ô∏è'} Confirmations*\n{transaction_infos['confirmations']} {'' if transaction_infos['confirmations'] >= 6 else '(Apr√®s 6 confirmations, la transaction est consid√©r√© comme termin√© et irr√©versible.)'}\n\n*üóìÔ∏è Re√ßu*\n{date} UTC"
            text.replace("\n\n", "\n")

              
            message = bot.edit_message_text(chat_id=call.from_user.id, 
                                            message_id=temp[call.from_user.id]['message'],
                                            text=text, 
                                            reply_markup=markup,
                                            parse_mode='Markdown')
        else:
            message = bot.edit_message_text(chat_id=call.from_user.id, 
                                            message_id=temp[call.from_user.id]['message'],
                                            text=f"*üìÇ Transaction {transaction_data[1]['name']}*\n\nBlockchain : {transaction_data[1]['coin_symbol'].upper()}\nTXID : {transaction_data[0]}\n\n*‚ö†Ô∏è La transaction que vous essayer de suivre est introuvable !*", 
                                            reply_markup=markup,
                                            parse_mode='Markdown')

    if call.data.startswith('delete_transaction:'):
        bot.clear_step_handler_by_chat_id(call.from_user.id)
        bot.answer_callback_query(call.id)
        
        transaction_txid = call.data[19:]
        
        markup.add(InlineKeyboardButton("‚Ü™Ô∏è Retour", callback_data="my_transactions:1"))  
        
        if user.del_transaction(txid=transaction_txid):
            message = bot.edit_message_text(chat_id=call.from_user.id, 
                                    message_id=temp[call.from_user.id]['message'],
                                    text="*üßæ Le suivis √† √©t√© supprim√©.*", 
                                    reply_markup=markup,
                                    parse_mode='Markdown')
        else:
            message = bot.edit_message_text(chat_id=call.from_user.id, 
                                    message_id=temp[call.from_user.id]['message'],
                                    text="*‚ö†Ô∏è Une erreur est survenue lors de la supression*", 
                                    reply_markup=markup,
                                    parse_mode='Markdown')
            
            
            
def contact_send_message(message):
    for administrator_id in ADMINISTRATORS:
        bot.send_message(administrator_id, f"*üîî Vous avez un nouveau message !*\n\nMessage de : {message.from_user.username} ({message.from_user.id})\n{message.text}", parse_mode='Markdown')     
        
    bot.delete_message(message.chat.id, message.id)
    
    markup = InlineKeyboardMarkup()
    
    markup.add(InlineKeyboardButton("‚Ü™Ô∏è Retour au menu principal", callback_data="back_to_menu"))
    
    message = bot.edit_message_text(chat_id=message.chat.id, 
                                    message_id=temp[message.from_user.id]['message'],
                                    text="‚úÖ Votre message √† bien √©t√© re√ßu !", 
                                    reply_markup=markup,
                                    parse_mode='Markdown')   
    
    
def new_transaction_step_txid(message):
    bot.delete_message(message.chat.id, message.id)
    
    user = User(user_id=message.from_user.id)
    
    temp[message.from_user.id]['new_transaction']['txid'] = message.text
    
    markup = InlineKeyboardMarkup()
    
    markup.add(InlineKeyboardButton("‚ùå Annuler", callback_data="back_to_menu"))
    
    message = bot.edit_message_text(chat_id=message.chat.id, 
                                    message_id=temp[message.from_user.id]['message'],
                                    text=f"üßæ *Entrer le nom de la transaction*\n\nBlockchain : {temp[message.from_user.id]['new_transaction']['coin_symbol'].upper()}\nTXID : {message.text}", 
                                    reply_markup=markup,
                                    parse_mode='Markdown')   
    
    bot.register_next_step_handler(message, new_transaction_step_name)
    
def new_transaction_step_name(message):
    bot.delete_message(message.chat.id, message.id)
    
    user = User(user_id=message.from_user.id)
    
    temp[message.from_user.id]['new_transaction']['name'] = message.text

    user.add_transaction(txid= temp[message.from_user.id]['new_transaction']['txid'],
                         name= temp[message.from_user.id]['new_transaction']['name'],
                         coin_symbol= temp[message.from_user.id]['new_transaction']['coin_symbol'],
                         finished= temp[message.from_user.id]['new_transaction']['finished']
                         )
    
    markup = InlineKeyboardMarkup()
    
    markup.add(InlineKeyboardButton("‚Ü™Ô∏è Retour au menu principal", callback_data="back_to_menu"))
    
    message = bot.edit_message_text(chat_id=message.chat.id, 
                                    message_id=temp[message.from_user.id]['message'],
                                    text=f"‚úÖ *Nouveau suivi ajout√©*\n\nNom : {temp[message.from_user.id]['new_transaction']['name']}\nBlockchain : {temp[message.from_user.id]['new_transaction']['coin_symbol'].upper()}\nTXID : {temp[message.from_user.id]['new_transaction']['txid']}", 
                                    reply_markup=markup,
                                    parse_mode='Markdown') 
    
      
bot.infinity_polling()